name: Build and Deploy
on:
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Setup Node 👾
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install and Build 🔧
        run: |
          npm ci
          npm run build-storybook
      - name: Fossa dependency analysis 🐛
        with:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          curl "https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh" -o "install-fossa-cli-latest.sh"
          chmod +x ./install-fossa-cli-latest.sh 
          ./install-fossa-cli-latest.sh
          sudo apt-get install -y yq
          
          curl -X 'POST' 'https://app.fossa.com/api/teams' -H "Authorization: Bearer $FOSSA_API_KEY" -H 'accept: application/json' -H 'Content-Type: application/json' -d '{ "name": "'"$TEAM_NAME"'" }'
          fossa analyze --team $(yq .service.owner opslevel.yml) --project smores-react --project-url https://github.com/marshmallow-insurance/smores-react --policy "Frontend Security Policy"
      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages # The branch the action should deploy to.
          FOLDER: storybook-static # The folder that the build-storybook script generates files.
          CLEAN: true # Automatically remove deleted files from the deploy branch
